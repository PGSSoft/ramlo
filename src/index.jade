//JADE supports includes, so the file will be splitted in different files

// JADE Functions used for TYPES -----------

mixin produceTypeNode(t)
    - var firstChar = t.charAt(0)

    //if firstChar is uppercase, it is defined in Types otherwise is default raml type
    if firstChar == firstChar.toUpperCase()
        a(href="#" + t)= t

    else
        span= t

mixin getTypesType(type)

    //...[type][type] is array
    each t in type
        if t.indexOf("|") < -1
            +produceTypeNode(t)

        else
            - var types = t.split("|")
            each _t,index in types
                +produceTypeNode(_t)
                if index < (types.length-1)
                    span |

mixin typePropsTable( properties)

    table(class='documentation__parameters table')
        thead
            tr
                th name
                th type
                th enum
        tbody
            each prop in  properties
                tr( id=prop.name  )
                    if prop.displayName
                        td
                            span= prop.displayName
                            if prop.required
                                span(class='text-primary') *
                    else
                        td -

                    if prop.type
                        td= prop.type
                    else
                        td -

                    if prop.enum
                        td= prop.enum
                    else
                        td -


mixin typeTable(typeObj)

    - var excludedArr = ["__METADATA__", "name", "displayName", "example", "repeat", "required", "structuredExample" ]

    each type in typeObj

        section(class="documentation row")
            .documentation__endpoints
                .documentation__endpoints__params
                    h2(id=type.name  class='documentation__subheader' )
                        span= type.displayName
                        if type.required
                            span(class='text-primary') *
                    table(class='documentation__parameters table')

                        thead
                                tr
                                    each tp,index in type
                                        if excludedArr.indexOf(index) < 0
                                            th= index
                        tbody
                                tr
                                    each tp,index in type
                                        if excludedArr.indexOf(index) < 0
                                            if index == "type"
                                                td
                                                    +getTypesType( tp )
                                            else if index == "properties"
                                                td
                                                    +typePropsTable(tp)
                                            else if index == "items"
                                                td
                                                    each item in tp.type
                                                        span= item
                                            else
                                                td= tp

                .documentation__endpoints__examples
                    if type.structuredExample
                        div
                            span {
                            ul
                                each val,k in type.structuredExample
                                    li= k + " : " + val
                            span }
                    else
                        if type.example
                            div
                                span= JSON.stringify( type.example )

doctype html
html(lang="en")
    head
        meta(charset='utf-8')
        meta(name='viewport', content='width=device-width, initial-scale=1, shrink-to-fit=no')
        meta(http-equiv='x-ua-compatible', content='ie=edge')

        title #{api.apiTitle} :: generated by ramlo

        style(type='text/css')
            include main.css
        script(src="https://code.jquery.com/jquery-2.2.3.min.js" integrity="sha256-a23g1Nt4dtEYOj7bR+vTu7+T8VP13humZFBJNIYoEJo=" crossorigin="anonymous")
        script(type="text/javascript")
            include index.js
    body
        header(class='header')
            .container-fluid
                h1(class='header__title', title=api.apiProtocol )= api.apiTitle
                p(class='header__subtitle')= api.apiDescription
                span(class='header__uri text-primary #{api.apiDescription ? "pull-xs-right" : ""}')= api.apiBaseUri
                if api.baseUriParameters.length > 0
                    div
                        H4 Base Uri Parameters

                        table(class='documentation__parameters table')
                            thead
                                tr
                                    th name
                                    th type
                                    th repeat
                                    th description
                            tbody
                                each parameter in api.baseUriParameters
                                    tr
                                        td= parameter.name
                                            if parameter.required
                                                span(class='text-primary') *
                                        td= parameter.type
                                        td= parameter.repeat
                                        td= parameter.description

        main
            - var globId = 0;
            .container-fluid
                .row
                    .col-md-2.sidebar
                        section(class='resources sidebar-content')
                            h1(class='resources__header') Resources
                            ul(class='resources__list')
                                if Object.keys(api.apiSecuredBy).length > 0
                                    li= "Authentication"
                                each resource in api.apiResources
                                    li= resource.name
                                    ul(class='resources__list__endpoints')
                                        each endpoint in resource.endpoints
                                            li
                                                case endpoint.method
                                                    when 'get': span(class='label label-primary')= endpoint.method
                                                    when 'post': span(class='label label-success')= endpoint.method
                                                    when 'put': span(class='label label-warning')= endpoint.method
                                                    when 'delete': span(class='label label-danger')= endpoint.method
                                                a(href='#' + '#{helpers.uriWithMethodIdentifier(endpoint.uri, endpoint.method)}')= endpoint.uri
                    .col-md-10.col-md-offset-2
                        each documentation in api.apiDocumentations
                            section(class='documentation')
                                h1(class='documentation__header')= documentation.title
                                p(class='documentation__content')= documentation.content

                        if Object.keys(api.apiSecuredBy).length > 0
                            section(class='documentation row authentication')
                                h1(class='documentation__header')= "Authentication - " + api.apiSecuredBy.type
                                p(class='documentation__content')= api.apiSecuredBy.descripton



                        each resource in api.apiResources
                            section(class='documentation row')
                                h1(class='documentation__header')= resource.name
                                div(class='documentation__description')= resource.description
                                each endpoint in resource.endpoints
                                    div(class='documentation__endpoints')
                                        a(name='#{helpers.uriWithMethodIdentifier(endpoint.uri, endpoint.method)}')
                                        .documentation__endpoints__params
                                            p(class='documentation__endpoints__name')
                                                case endpoint.method
                                                    when 'get': span(class='label label-primary')= endpoint.method
                                                    when 'post': span(class='label label-success')= endpoint.method
                                                    when 'put': span(class='label label-warning')= endpoint.method
                                                    when 'delete': span(class='label label-danger')= endpoint.method
                                                = endpoint.uri

                                            div(class='documentation__endpoints__description') !{endpoint.description}

                                            if endpoint.uriParameters && endpoint.uriParameters["tbody"]
                                                if endpoint.uriParameters["tbody"].length

                                                    table(class='documentation__parameters table')
                                                        thead
                                                            tr
                                                                if endpoint.uriParameters.thead.name
                                                                    th name

                                                                if endpoint.uriParameters.thead.type
                                                                    th type

                                                                if endpoint.uriParameters.thead.description
                                                                    th description
                                                        tbody
                                                            each parameter in endpoint.uriParameters["tbody"]
                                                                tr
                                                                    if endpoint.uriParameters.thead.name
                                                                        td= parameter.name

                                                                    if endpoint.uriParameters.thead.type
                                                                        td= parameter.type

                                                                    if endpoint.uriParameters.thead.description
                                                                        td= parameter.description

                                            if endpoint.queryParameters && endpoint.queryParameters["tbody"]
                                                if endpoint.queryParameters["tbody"].length
                                                    h2(class='documentation__subheader') Query Parameters
                                                    table(class='documentation__parameters table')
                                                        thead
                                                            tr
                                                                if endpoint.queryParameters.thead.name
                                                                    th name

                                                                if endpoint.queryParameters.thead.type
                                                                    th type

                                                                if endpoint.queryParameters.thead.description
                                                                    th description

                                                                if endpoint.queryParameters.thead.default
                                                                    th default

                                                                if endpoint.queryParameters.thead.minLength
                                                                    th min

                                                                if endpoint.queryParameters.thead.maxLength
                                                                    th max

                                                                if endpoint.queryParameters.thead.example
                                                                    th example
                                                        tbody
                                                            each parameter in endpoint.queryParameters["tbody"]
                                                                tr
                                                                    if endpoint.queryParameters.thead.name
                                                                        td= parameter.name
                                                                        if parameter.isRequired
                                                                            span(class='text-primary') *

                                                                    if endpoint.queryParameters.thead.type
                                                                        if parameter.repeat
                                                                            td [ #{parameter.type} ]
                                                                        else
                                                                            td #{parameter.type}

                                                                    if endpoint.queryParameters.thead.description
                                                                        td= parameter.description

                                                                    if endpoint.queryParameters.thead.default
                                                                        td= parameter.default

                                                                    if endpoint.queryParameters.thead.minLength
                                                                        td= parameter.minLength

                                                                    if endpoint.queryParameters.thead.maxLength
                                                                        td= parameter.maxLength

                                                                    if endpoint.queryParameters.thead.example
                                                                        td= parameter.example

                                            if endpoint.requestBody && endpoint.requestBody["tbody"]
                                                if endpoint.requestBody["tbody"].length
                                                    h2(class='documentation__subheader') Request
                                                    table(class='documentation__parameters table')
                                                        thead
                                                            tr
                                                                if endpoint.requestBody.thead.name
                                                                    th name

                                                                if endpoint.requestBody.thead.type
                                                                    th type

                                                                if endpoint.requestBody.thead.description
                                                                    th description
                                                        tbody
                                                            each property in endpoint.requestBody.tbody
                                                                tr
                                                                    if endpoint.requestBody.thead.name
                                                                        td= property.name
                                                                        if property.isRequired
                                                                            span(class='text-primary') *

                                                                    if endpoint.requestBody.thead.type
                                                                        td= property.type

                                                                    if endpoint.requestBody.thead.description
                                                                        td= property.description

                                            if endpoint.responseBody

                                                h2(class='documentation__subheader')= 'Response '
                                                span(class='text-success') (200)

                                                if endpoint.responseBody["type"]
                                                    h4 Type
                                                    if endpoint.responseBody["type"].name
                                                        span(class="typeName")= endpoint.responseBody["type"].name
                                                    if endpoint.responseBody["type"].type
                                                        span(class="typeType")= " | type: "
                                                        +getTypesType(endpoint.responseBody["type"].type)
                                                    if endpoint.responseBody["type"].schema
                                                        div(class="typeType") Schema
                                                        div= endpoint.responseBody["type"].schema


                                                    //dumping data for the moment, need to add properties
                                                    div
                                                        if endpoint.responseBody["type"].properties
                                                            h6 Properties
                                                            +typePropsTable( endpoint.responseBody["type"].properties )


                                                if endpoint.responseBody["tbody"]

                                                    if endpoint.responseBody["tbody"].length
                                                        table(class='documentation__parameters table')
                                                            thead
                                                                tr
                                                                    if endpoint.responseBody.thead.name
                                                                        th name

                                                                    if endpoint.responseBody.thead.type
                                                                        th type

                                                                    if endpoint.responseBody.thead.description
                                                                        th description
                                                            tbody
                                                                each property in endpoint.responseBody.tbody
                                                                    tr
                                                                        if endpoint.responseBody.thead.name
                                                                            td= property.name
                                                                            if property.isRequired
                                                                                span(class='text-primary') *

                                                                        if endpoint.responseBody.thead.type
                                                                            td= property.type

                                                                        if endpoint.responseBody.thead.description
                                                                            td= property.description

                                                                    if property.nestedProperties.tbody
                                                                        if property.nestedProperties.tbody.length
                                                                            each nested in property.nestedProperties.tbody
                                                                                tr(class='documentation__parameters__nested')
                                                                                    if endpoint.responseBody.thead.name
                                                                                        td= nested.name
                                                                                        if nested.isRequired
                                                                                            span(class='text-primary') *

                                                                                    if property.nestedProperties.thead.type
                                                                                        td= nested.type

                                                                                    if property.nestedProperties.thead.description
                                                                                        td= nested.description

                                        .documentation__endpoints__examples
                                            if endpoint.responseExample
                                                h2(class='documentation__subheader')= ' Response examples '
                                                ul.examples__tabs
                                                    each example, index in endpoint.responseExample
                                                        li.example__tab
                                                            - var check = index === 0;
                                                            input(class='text-success' type='radio' name='example-tabs#{globId}' id='example-tab#{globId + index}' checked=check)
                                                            label(for='example-tab#{globId + index}') (#{example.code})
                                                ul.examples__contents
                                                    each example, index in endpoint.responseExample
                                                        - var check = index === 0;
                                                        pre.example__content(class=check ? "is-active" : "" id='example-content#{globId + index}' data-tab='example-tab#{globId + index}')
                                                            code !{example.response}
                                                - globId += endpoint.responseExample.length;


                        //-- TYPES
                        if api.apiAllTypes.length > 0
                            section(id='allTypes')
                                h1 All Types
                                div(class="documentation__description")
                                    span All defined data types listed below
                                #typesContainer
                                    each typeObj in api.apiAllTypes
                                        //generate types table
                                        +typeTable(typeObj)

                        //-- schemas
                        if api.apiAllSchemas.length > 0
                            section(id='allTypes')
                                h1 All Schemas
                                div(class="documentation__description")
                                    span All defined schemas listed below
                                #typesContainer
                                    each typeObj in api.apiAllSchemas
                                        //generate types table

                                        each ob, index in typeObj
                                            div
                                                h4= index
                                                div= JSON.stringify(ob)
                                                    //+typeTable( )


                        //-- SECURITY SCHEMAS
                        if api.apiSecuritySchemes.length > 0
                            div(class='securityScheme')
                            each securityScheme in api.apiSecuritySchemes
                                if securityScheme.type
                                    h2(id=securityScheme.type)= securityScheme.type
                                if securityScheme.description
                                    p(class='description')= securityScheme.description

                                if securityScheme.settings
                                    h4 Settings
                                    ul
                                        if securityScheme.settings.requestTokenUri
                                            li
                                                span(class='setTitle')='requestTokenUri:'
                                                span(class='setDesc')= securityScheme.settings.requestTokenUri

                                        if securityScheme.settings.authorizationUri
                                            li
                                                span(class='setTitle')='authorizationUri:'
                                                span(class='setDesc')= securityScheme.settings.authorizationUri

                                        if securityScheme.settings.tokenCredentialsUri
                                            li
                                                span(class='setTitle')='tokenCredentialsUri:'
                                                span(class='setDesc')= securityScheme.settings.tokenCredentialsUri

                                        if securityScheme.settings.signatures
                                            li
                                                span(class='setTitle')='signatures:'
                                                span(class='setDesc')= securityScheme.settings.signatures


                                        if securityScheme.settings.accessTokenUri
                                            li
                                                span(class='setTitle')='accessTokenUri:'
                                                span(class='setDesc')= securityScheme.settings.accessTokenUri

                                        if securityScheme.settings.authorizationGrants
                                            li
                                                span(class='setTitle')='authorizationGrants:'
                                                span(class='setDesc')= securityScheme.settings.authorizationGrants

                                        if securityScheme.settings.scopes
                                            li
                                                span(class='setTitle')='scopes:'
                                                span(class='setDesc')= securityScheme.settings.scopes


                                if securityScheme.describedBy
                                    div(class='documentation__endpoints__description')
                                        h4 Described By

                                            if securityScheme.describedBy.headers
                                                h2(class='documentation__subheader') Headers
                                                each auth,index in securityScheme.describedBy.headers

                                                    table(class='documentation__parameters table')
                                                        thead
                                                            tr
                                                                th name
                                                                if auth.type
                                                                    th type
                                                                if auth.description
                                                                    th description
                                                        tbody
                                                            tr
                                                                th= index
                                                                if auth.type
                                                                    td= auth.type

                                                                if auth.description
                                                                    td= auth.description

                                            if securityScheme.describedBy.queryParameters
                                                h2(class='documentation__subheader') Query Parameters

                                                each auth,index in securityScheme.describedBy.queryParameters

                                                    table(class='documentation__parameters table')
                                                        thead
                                                            tr
                                                                th name
                                                                if auth.type
                                                                    th type
                                                                if auth.description
                                                                    th description
                                                        tbody
                                                            tr
                                                                th= index
                                                                if auth.type
                                                                    td= auth.type
                                                                if auth.description
                                                                    td= auth.description

                                            if securityScheme.describedBy.responses
                                                h2(class='documentation__subheader') Responses

                                                each auth,index in securityScheme.describedBy.responses

                                                    table(class='documentation__parameters table')
                                                        thead
                                                            tr
                                                                th name
                                                                if auth.type
                                                                    th type
                                                                if auth.description
                                                                    th description
                                                        tbody
                                                            tr
                                                                th= index
                                                                if auth.type
                                                                    td= auth.type

                                                                if auth.description
                                                                    td= auth.description











footer(class='footer')
            .container-fluid
                p(class='footer__text') powered by
                    a(href='https://github.com/PGSSoft/ramlo') ramlo